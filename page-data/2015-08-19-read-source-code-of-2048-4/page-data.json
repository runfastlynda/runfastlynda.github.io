{"componentChunkName":"component---src-templates-blog-post-js","path":"/2015-08-19-read-source-code-of-2048-4/","result":{"data":{"site":{"siteMetadata":{"title":"runfastlyndağŸ‘€"}},"markdownRemark":{"id":"d9174740-0537-5b4a-8a68-784a8efc6ac0","excerpt":"å·²ç»é˜…è¯»å®Œlocalstoragemanager.jså’Œkeyboardinputmanager.jsï¼Œè¿™æ¬¡é˜…è¯» html_actuator.jsã€‚ HTMLActuatorå‡½æ•°æœ‰å¦‚ä¸‹ç»“æ„ï¼š åœ¨å‡½æ•°çš„æœ€å¼€å§‹è·å–äº†tile-containerï¼Œscore-containerï¼Œbest-containerï¼Œgameâ€¦","html":"<p>å·²ç»é˜…è¯»å®Œ<a href=\"http://runfastlynda.com/2048-local-storage-manager/\">local<em>storage</em>manager.js</a>å’Œ<a href=\"http://runfastlynda.com/2048-input-mannager/\">keyboard<em>input</em>manager.js</a>ï¼Œè¿™æ¬¡é˜…è¯» html_actuator.jsã€‚</p>\n<p>HTMLActuatorå‡½æ•°æœ‰å¦‚ä¸‹ç»“æ„ï¼š<img src=\"http://7xjufd.dl1.z0.glb.clouddn.com/blog4.1.png\"></p>\n<p>åœ¨å‡½æ•°çš„æœ€å¼€å§‹è·å–äº†tile-containerï¼Œscore-containerï¼Œbest-containerï¼Œgame-messageçš„domèŠ‚ç‚¹ã€‚</p>\n<p>åœ¨HTMLActuatorçš„prototypeä¸Šå®šä¹‰äº†actuateæ–¹æ³•ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯è¿™ä¸ªå‡½æ•°çš„ç¬¬ä¸€å¥è¿ç”¨ä¸­é—´å˜é‡ï¼Œå›ºå®šthisçš„ç¡®åˆ‡æŒ‡å‘ï¼Œç¡®å®šæ‰§è¡Œçš„ä½œç”¨åŸŸã€‚é˜²æ­¢å‡½æ•°å†…éƒ¨çš„å¤šå±‚thiså¯¼è‡´thisçš„æŒ‡å‘æ˜¯ä¸ç¡®å®šçš„ã€‚</p>\n<p>ç´§æ¥ç€window.requestAnimationFrame()è¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥åœ¨é¡µé¢é‡ç»˜ä¹‹å‰ï¼Œé€šçŸ¥æµè§ˆå™¨è°ƒç”¨æ¥å—çš„å‡½æ•°ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">HTMLActuator</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">actuate</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">grid<span class=\"token punctuation\">,</span> metadata</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> self <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n  window<span class=\"token punctuation\">.</span><span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    self<span class=\"token punctuation\">.</span><span class=\"token function\">clearContainer</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>tileContainer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//éå†cellsï¼Œå¦‚æœå­˜åœ¨cellï¼Œå°±æ·»åŠ tile</span>\n    grid<span class=\"token punctuation\">.</span>cells<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">column</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      column<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">cell</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cell<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          self<span class=\"token punctuation\">.</span><span class=\"token function\">addTile</span><span class=\"token punctuation\">(</span>cell<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//æ›´æ–°åˆ†æ•°</span>\n    self<span class=\"token punctuation\">.</span><span class=\"token function\">updateScore</span><span class=\"token punctuation\">(</span>metadata<span class=\"token punctuation\">.</span>score<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    self<span class=\"token punctuation\">.</span><span class=\"token function\">updateBestScore</span><span class=\"token punctuation\">(</span>metadata<span class=\"token punctuation\">.</span>bestScore<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">//åˆ¤æ–­æ¸¸æˆçš„è¾“èµ¢</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>metadata<span class=\"token punctuation\">.</span>terminated<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>metadata<span class=\"token punctuation\">.</span>over<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        self<span class=\"token punctuation\">.</span><span class=\"token function\">message</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// You lose</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>metadata<span class=\"token punctuation\">.</span>won<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        self<span class=\"token punctuation\">.</span><span class=\"token function\">message</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// You win!</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>clearContaineræ–¹æ³•ï¼ŒaddTileæ–¹æ³•ï¼ŒupdateScoreæ–¹æ³•ï¼ŒupdateBestScoreæ–¹æ³•ï¼Œmessageæ–¹æ³•æˆ‘ä»¬åœ¨prototypeä¸Šéƒ½å¯ä»¥æ‰¾åˆ°ã€‚</p>\n<p>æ¯”è¾ƒé‡è¦çš„æ˜¯åœ¨HTMLActuatorçš„prototypeä¸Šå®šä¹‰çš„addTileæ–¹æ³•ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">HTMLActuator</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">addTile</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">tile</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> self <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">var</span> wrapper   <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"div\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> inner     <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"div\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> position  <span class=\"token operator\">=</span> tile<span class=\"token punctuation\">.</span>previousPosition <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> tile<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> tile<span class=\"token punctuation\">.</span>y <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> positionClass <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">positionClass</span><span class=\"token punctuation\">(</span>position<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> classes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"tile\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"tile-\"</span> <span class=\"token operator\">+</span> tile<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span> positionClass<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tile<span class=\"token punctuation\">.</span>value <span class=\"token operator\">></span> <span class=\"token number\">2048</span><span class=\"token punctuation\">)</span> classes<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tile-super\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">applyClasses</span><span class=\"token punctuation\">(</span>wrapper<span class=\"token punctuation\">,</span> classes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  inner<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tile-inner\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  inner<span class=\"token punctuation\">.</span>textContent <span class=\"token operator\">=</span> tile<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tile<span class=\"token punctuation\">.</span>previousPosition<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//ç¡®ä¿tileåœ¨å…ˆå‰çš„ä½ç½®ä¸Šå‘ˆç°</span>\n    window<span class=\"token punctuation\">.</span><span class=\"token function\">requestAnimationFrame</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      classes<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">positionClass</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> tile<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> tile<span class=\"token punctuation\">.</span>y <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      self<span class=\"token punctuation\">.</span><span class=\"token function\">applyClasses</span><span class=\"token punctuation\">(</span>wrapper<span class=\"token punctuation\">,</span> classes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">//æ›´æ–°ä½ç½®</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tile<span class=\"token punctuation\">.</span>mergedFrom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    classes<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tile-merged\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">applyClasses</span><span class=\"token punctuation\">(</span>wrapper<span class=\"token punctuation\">,</span> classes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">//é€šè¿‡ç§»åŠ¨ï¼Œæœ‰åˆå¹¶æƒ…å†µï¼Œåˆå¹¶åçš„tile</span>\n    tile<span class=\"token punctuation\">.</span>mergedFrom<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">merged</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      self<span class=\"token punctuation\">.</span><span class=\"token function\">addTile</span><span class=\"token punctuation\">(</span>merged<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ä»€ä¹ˆéƒ½æ²¡æœ‰çš„æ·»åŠ ä¸€ä¸ªæ–°çš„tile</span>\n    classes<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"tile-new\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">applyClasses</span><span class=\"token punctuation\">(</span>wrapper<span class=\"token punctuation\">,</span> classes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// æŠŠinnerç›’å­æ·»åŠ wrapperç›’å­ä¸­</span>\n  wrapper<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>inner<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// æŠŠwrapperæ”¾åˆ°tileContainerè¿™ä¸ªç›’å­é‡Œ</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>tileContainer<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>wrapper<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>è¿™é‡Œè¿˜å®šä¹‰äº†æ›´æ–°åˆ†æ•°çš„æ–¹æ³•ï¼Œå…ˆæŠŠæ–°çš„æˆç»©æ›´æ–°ï¼Œç„¶ååˆç»™åŠ åˆ†è¿™ä¸€è¡Œä¸ºæ·»åŠ äº†åŠ¨ç”»</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">HTMLActuator</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">updateScore</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">score</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">clearContainer</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>scoreContainer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">var</span> difference <span class=\"token operator\">=</span> score <span class=\"token operator\">-</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>score<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>score <span class=\"token operator\">=</span> score<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>scoreContainer<span class=\"token punctuation\">.</span>textContent <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>score<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">//å®šä¹‰äº†åˆ†æ•°æ›´æ–°çš„åŠ¨ç”»</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>difference <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> addition <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"div\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    addition<span class=\"token punctuation\">.</span>classList<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"score-addition\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    addition<span class=\"token punctuation\">.</span>textContent <span class=\"token operator\">=</span> <span class=\"token string\">\"+\"</span> <span class=\"token operator\">+</span> difference<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>scoreContainer<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>addition<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>å…¶ä»–æ–¹æ³•ï¼š</p>\n<ul>\n<li>ç»§ç»­æ¸¸æˆ\nHTMLActuator.prototype.continueGame</li>\n<li>æ¸…é™¤ç›’å­\nHTMLActuator.prototype.clearContainer</li>\n<li>åº”ç”¨cssæ ·å¼\nHTMLActuator.prototype.applyClasses</li>\n<li>è·å–ä½ç½®\nHTMLActuator.prototype.normalizePosition</li>\n<li>åˆ©ç”¨ä½ç½®ç¡®å®šcssæ ·å¼\nHTMLActuator.prototype.positionClass</li>\n<li>æ›´æ–°æœ€å¥½çš„æˆç»©\nHTMLActuator.prototype.updateBestScore</li>\n<li>æ¸¸æˆç»“æŸæ—¶å¼¹å‡ºçš„ä¿¡æ¯\nHTMLActuator.prototype.message</li>\n<li>ç»§ç»­æ¸¸æˆæ—¶å¼¹å‡ºä¿¡æ¯æ¸…é™¤æ‰\nHTMLActuator.prototype.clearMessage</li>\n</ul>","frontmatter":{"title":"2048æºä»£ç è§£è¯»ï¼ˆ4ï¼‰","date":"August 19, 2015"},"fields":{"slug":"/2015-08-19-read-source-code-of-2048-4/"}}},"pageContext":{"slug":"/2015-08-19-read-source-code-of-2048-4/","previous":{"fields":{"slug":"/2015-08-18-2048-local-storage-manager/"},"frontmatter":{"title":"2048æºä»£ç è§£è¯»ï¼ˆ3ï¼‰","tags":["æºç é˜…è¯»"]}},"next":{"fields":{"slug":"/2015-08-26-read-source-code-of-2048-5/"},"frontmatter":{"title":"2048æºä»£ç è§£è¯»ï¼ˆ5ï¼‰","tags":["æºç é˜…è¯»"]}}}}}