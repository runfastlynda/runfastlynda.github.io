{"componentChunkName":"component---src-templates-blog-post-js","path":"/2015-08-26-read-source-code-of-2048-5/","result":{"data":{"site":{"siteMetadata":{"title":"runfastlyndağŸ‘€"}},"markdownRemark":{"id":"1609a84c-1cd4-5c80-8ea4-37de0980bf39","excerpt":"2048æºç è§£è¯»ç³»åˆ—æœ€åä¸€ç¯‡ï¼Œæˆ‘ä»¬æ¥è§£è¯»æœ€é‡è¦çš„ GameManager éƒ¨åˆ†ã€‚ GameManagerå‡½æ•°æœ‰å¦‚ä¸‹ç»“æ„ï¼š å‡½æ•°è¾“å…¥äº†size, InputManager, Actuator, StorageManagerè¿™å››ä¸ªå‚æ•°ï¼Œè¿™éƒ½æ˜¯ä¹‹å‰æˆ‘ä»¬è§£è¯»è¿‡çš„ï¼Œ\nå‚æ•°ä¼ å…¥åï¼Œsize èµ‹å€¼ç»™å½“å‰å¯¹è±¡çš„sizeâ€¦","html":"<p>2048æºç è§£è¯»ç³»åˆ—æœ€åä¸€ç¯‡ï¼Œæˆ‘ä»¬æ¥è§£è¯»æœ€é‡è¦çš„ GameManager éƒ¨åˆ†ã€‚</p>\n<p>GameManagerå‡½æ•°æœ‰å¦‚ä¸‹ç»“æ„ï¼š<img src=\"http://7xjufd.dl1.z0.glb.clouddn.com/blog5.1.png\"></p>\n<p>å‡½æ•°è¾“å…¥äº†size, InputManager, Actuator, StorageManagerè¿™å››ä¸ªå‚æ•°ï¼Œè¿™éƒ½æ˜¯ä¹‹å‰æˆ‘ä»¬è§£è¯»è¿‡çš„ï¼Œ\nå‚æ•°ä¼ å…¥åï¼Œsize èµ‹å€¼ç»™å½“å‰å¯¹è±¡çš„sizeï¼Œå…¶ä»–ä¸‰ä¸ªå‚æ•°é€šè¿‡newå‘½ä»¤è°ƒç”¨äº†æ„é€ å‡½æ•°ï¼Œè¿”å›ä¸‰ä¸ªå®ä¾‹å¯¹è±¡ï¼Œ\nåˆå§‹åŒ–tileå¼€å§‹æ—¶ä¸º2ä¸ªï¼Œç»‘å®šinputmanagerçš„moveï¼Œrestartï¼ŒkeepPlayingåˆ°å½“å‰å¯¹è±¡ï¼Œ\næœ€åæ˜¯é‡è¦çš„setupå‡½æ•°ã€‚</p>\n<h5>setupå‡½æ•°</h5>\n<p>setupå‡½æ•°å®šä¹‰æ¸¸æˆçš„æ‰§è¡Œæ–¹æ³•ï¼Œé¦–å…ˆä»storageManageré‡Œè·å–æ¸¸æˆçš„çŠ¶æ€ï¼Œå¦‚æœå­˜åœ¨ï¼Œ\næŠŠç›¸åº”çš„çŠ¶æ€ä¿¡æ¯ä¼ å…¥ï¼Œå¦åˆ™ï¼Œåˆå§‹åŒ–è¿™äº›çŠ¶æ€ä¿¡æ¯ã€‚ç„¶åå¼€å§‹æ‰§è¡Œæ¸¸æˆï¼šactuate()ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">GameManager</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">setup</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//å–å¾—æ¸¸æˆçŠ¶æ€</span>\n  <span class=\"token keyword\">var</span> previousState <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>storageManager<span class=\"token punctuation\">.</span><span class=\"token function\">getGameState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// å¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆåŠ è½½ä¹‹å‰çš„æ¸¸æˆã€‚å¦åˆ™åˆå§‹åŒ–æ¸¸æˆçš„å¼€å§‹çŠ¶æ€</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>previousState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>grid        <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Grid</span><span class=\"token punctuation\">(</span>previousState<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">,</span>\n                            previousState<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">.</span>cells<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Reload grid</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>score       <span class=\"token operator\">=</span> previousState<span class=\"token punctuation\">.</span>score<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>over        <span class=\"token operator\">=</span> previousState<span class=\"token punctuation\">.</span>over<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>won         <span class=\"token operator\">=</span> previousState<span class=\"token punctuation\">.</span>won<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>keepPlaying <span class=\"token operator\">=</span> previousState<span class=\"token punctuation\">.</span>keepPlaying<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>grid        <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Grid</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>score       <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>over        <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>won         <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>keepPlaying <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// æ·»åŠ tile</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">addStartTiles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">actuate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>è¿™é‡Œå®šä¹‰äº†æ·»åŠ åˆå§‹tileçš„æ–¹æ³•</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// è®¾ç½®åˆå§‹tileå¼€å§‹æ¸¸æˆ</span>\n<span class=\"token class-name\">GameManager</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">addStartTiles</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>startTiles<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">addRandomTile</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// åœ¨éšæœºä½ç½®æ·»åŠ ä¸€ä¸ªtileï¼Œè¿™é‡Œç»™tileæ·»åŠ å€¼ç”¨Math.random()çš„æ–¹æ³•ï¼Œ</span>\nå–å¾—åœ¨<span class=\"token number\">0</span><span class=\"token operator\">~</span><span class=\"token number\">1</span>ä¹‹é—´çš„éšæœºæ•°ï¼Œå¦‚æœå°äº<span class=\"token number\">0.9</span>ï¼Œå€¼ä¸º<span class=\"token number\">2</span>ï¼Œå¦åˆ™å€¼ä¸º<span class=\"token number\">4.</span>\n<span class=\"token class-name\">GameManager</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">addRandomTile</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">.</span><span class=\"token function\">cellsAvailable</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> value <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0.9</span> <span class=\"token operator\">?</span> <span class=\"token number\">2</span> <span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">var</span> tile <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Tile</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">.</span><span class=\"token function\">randomAvailableCell</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">.</span><span class=\"token function\">insertTile</span><span class=\"token punctuation\">(</span>tile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h5>moveå‡½æ•°</h5>\n<p>ç§»åŠ¨è¡Œä¸ºå¯¹åº”å‡½æ•°ï¼Œä¿å­˜å½“å‰tileä½ç½®ï¼Œå®šä¹‰äº†åˆå¹¶è¡Œä¸ºï¼Œå¦‚æœç›¸é‚»çš„ä¸¤ä¸ªtileçš„å€¼å­˜åœ¨ä¸”ç›¸ç­‰ï¼Œ\næ›´æ–°æˆç»©ä½ç½®</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">GameManager</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">move</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">direction</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ä½¿ç”¨ä¸­é—´å˜é‡å›ºå®šthiså¯¹è±¡</span>\n  <span class=\"token keyword\">var</span> self <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">isGameTerminated</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// å¦‚æœæ¸¸æˆç»“æŸï¼Œä¸åšä»»ä½•äº‹æƒ…</span>\n\n  <span class=\"token keyword\">var</span> cell<span class=\"token punctuation\">,</span> tile<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">var</span> vector     <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">getVector</span><span class=\"token punctuation\">(</span>direction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> traversals <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">buildTraversals</span><span class=\"token punctuation\">(</span>vector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> moved      <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// ä¿å­˜å½“å‰tileä½ç½®å¹¶åˆ é™¤åˆå¹¶ä¿¡æ¯</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">prepareTiles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// åœ¨æ­£ç¡®çš„æ–¹å‘ä¸Šç§»åŠ¨ç½‘æ ¼å’Œç§»åŠ¨çš„tile</span>\n  traversals<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">x</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    traversals<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">y</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      cell <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> x<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> y <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      tile <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">.</span><span class=\"token function\">cellContent</span><span class=\"token punctuation\">(</span>cell<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tile<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> positions <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">findFarthestPosition</span><span class=\"token punctuation\">(</span>cell<span class=\"token punctuation\">,</span> vector<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">var</span> next      <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">.</span><span class=\"token function\">cellContent</span><span class=\"token punctuation\">(</span>positions<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// å®šä¹‰äº†åˆå¹¶è¡Œä¸ºï¼Œå¦‚æœç›¸é‚»çš„ä¸¤ä¸ªtileçš„å€¼å­˜åœ¨ä¸”ç›¸ç­‰ï¼Œ</span>\n        å…ˆç”Ÿæˆæ–°çš„tileï¼Œä¿å­˜ä¿¡æ¯ï¼Œç„¶ååˆ é™¤å½“å‰çš„ä¸¤ä¸ªtile\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>next <span class=\"token operator\">&amp;&amp;</span> next<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> tile<span class=\"token punctuation\">.</span>value <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>next<span class=\"token punctuation\">.</span>mergedFrom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">var</span> merged <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Tile</span><span class=\"token punctuation\">(</span>positions<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">,</span> tile<span class=\"token punctuation\">.</span>value <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          merged<span class=\"token punctuation\">.</span>mergedFrom <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>tile<span class=\"token punctuation\">,</span> next<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n          self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">.</span><span class=\"token function\">insertTile</span><span class=\"token punctuation\">(</span>merged<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">.</span><span class=\"token function\">removeTile</span><span class=\"token punctuation\">(</span>tile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n          <span class=\"token comment\">// æ›´æ–°ä¸¤ä¸ªtileä½ç½®</span>\n          tile<span class=\"token punctuation\">.</span><span class=\"token function\">updatePosition</span><span class=\"token punctuation\">(</span>positions<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n          <span class=\"token comment\">// æ›´æ–°æˆç»©</span>\n          self<span class=\"token punctuation\">.</span>score <span class=\"token operator\">+=</span> merged<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">;</span>\n\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>merged<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> <span class=\"token number\">2048</span><span class=\"token punctuation\">)</span> self<span class=\"token punctuation\">.</span>won <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            self<span class=\"token punctuation\">.</span><span class=\"token function\">moveTile</span><span class=\"token punctuation\">(</span>tile<span class=\"token punctuation\">,</span> positions<span class=\"token punctuation\">.</span>farthest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>self<span class=\"token punctuation\">.</span><span class=\"token function\">positionsEqual</span><span class=\"token punctuation\">(</span>cell<span class=\"token punctuation\">,</span> tile<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            moved <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// tileä»åŸæ¥çš„cellç§»åŠ¨ï¼</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h5>buildTraversals</h5>\n<p>æ„å»ºä¸€ä¸ªä»¥æ­£ç¡®çš„é¡ºåºéå†çš„ä½ç½®åˆ—è¡¨ï¼Œæ˜¯å®è¡Œmoveå‡½æ•°çš„å…·ä½“ç»†èŠ‚</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">GameManager</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">buildTraversals</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">vector</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> traversals <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> pos <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> pos <span class=\"token operator\">&lt;</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span> pos<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    traversals<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>pos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    traversals<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>pos<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// æ€»æ˜¯ä»æœ€è¿œçš„å•å…ƒæ ¼ä¸­é€‰æ‹©æ–¹å‘</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>vector<span class=\"token punctuation\">.</span>x <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> traversals<span class=\"token punctuation\">.</span>x <span class=\"token operator\">=</span> traversals<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">.</span><span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>vector<span class=\"token punctuation\">.</span>y <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> traversals<span class=\"token punctuation\">.</span>y <span class=\"token operator\">=</span> traversals<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">.</span><span class=\"token function\">reverse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> traversals<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h5>findFarthestPositionå‡½æ•°</h5>\n<p>åˆå¹¶åŠ¨ä½œï¼Œåˆå¹¶ç›¸åŒçš„tileï¼Œç›´åˆ°ä¸èƒ½åˆå¹¶</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">GameManager</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">findFarthestPosition</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">cell<span class=\"token punctuation\">,</span> vector</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> previous<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// æœç€çŸ¢é‡æ–¹å‘å‰è¿›ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªéšœç¢ç‰©</span>\n  <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n    previous <span class=\"token operator\">=</span> cell<span class=\"token punctuation\">;</span>\n    cell     <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> previous<span class=\"token punctuation\">.</span>x <span class=\"token operator\">+</span> vector<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> previous<span class=\"token punctuation\">.</span>y <span class=\"token operator\">+</span> vector<span class=\"token punctuation\">.</span>y <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">.</span><span class=\"token function\">withinBounds</span><span class=\"token punctuation\">(</span>cell<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">.</span><span class=\"token function\">cellAvailable</span><span class=\"token punctuation\">(</span>cell<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      farthest<span class=\"token operator\">:</span> previous<span class=\"token punctuation\">,</span>\n      next<span class=\"token operator\">:</span> cell <span class=\"token comment\">// Used to check if a merge is required  ç”¨äºæ£€æŸ¥æ˜¯å¦éœ€è¦åˆå¹¶</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h5>tileMatchesAvailableå‡½æ•°</h5>\n<p>æ£€æŸ¥å¯ç”¨çš„åŒ¹é…ä¹‹é—´çš„tile</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">GameManager</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">tileMatchesAvailable</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> self <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">var</span> tile<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> x <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> x <span class=\"token operator\">&lt;</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span> x<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> y <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> y <span class=\"token operator\">&lt;</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">;</span> y<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      tile <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">.</span><span class=\"token function\">cellContent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> x<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> y <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tile<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> direction <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> direction <span class=\"token operator\">&lt;</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span> direction<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">var</span> vector <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span><span class=\"token function\">getVector</span><span class=\"token punctuation\">(</span>direction<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">var</span> cell   <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> x<span class=\"token operator\">:</span> x <span class=\"token operator\">+</span> vector<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">,</span> y<span class=\"token operator\">:</span> y <span class=\"token operator\">+</span> vector<span class=\"token punctuation\">.</span>y <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n          <span class=\"token keyword\">var</span> other  <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>grid<span class=\"token punctuation\">.</span><span class=\"token function\">cellContent</span><span class=\"token punctuation\">(</span>cell<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>other <span class=\"token operator\">&amp;&amp;</span> other<span class=\"token punctuation\">.</span>value <span class=\"token operator\">===</span> tile<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// è¿”å›tureï¼Œå°±å¯ä»¥åˆå¹¶</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span><span class=\"token comment\">// å¦åˆ™ä¸åˆå¹¶</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>","frontmatter":{"title":"2048æºä»£ç è§£è¯»ï¼ˆ5ï¼‰","date":"August 26, 2015"},"fields":{"slug":"/2015-08-26-read-source-code-of-2048-5/"}}},"pageContext":{"slug":"/2015-08-26-read-source-code-of-2048-5/","previous":{"fields":{"slug":"/2015-08-19-read-source-code-of-2048-4/"},"frontmatter":{"title":"2048æºä»£ç è§£è¯»ï¼ˆ4ï¼‰","tags":["æºç é˜…è¯»"]}},"next":{"fields":{"slug":"/2015-08-26-collapsing-margins/"},"frontmatter":{"title":"è¯´è¯´Collapsing Margins","tags":["CSS"]}}}}}